{% extends "su_base.html" %}
{% block content %}
<div class="relative">
    <!-- Sticky Buttons -->
    <div class="flex justify-end items-center space-x-4 p-4 sticky top-0 bg-white z-10">
        <button id="cancelBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Cancel
        </button>
        <button id="saveBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            Save
        </button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300" id="table-container">
            <thead>
                <tr class="w-full bg-gray-100 border-b">
                    <th class="text-left px-4 py-2">No</th>
                    <th class="text-left px-4 py-2">Name</th>
                    <th class="text-left px-4 py-2">Email</th>
                    <th class="text-left px-4 py-2">Role</th>
                    <th class="text-left px-4 py-2">Approve</th>
                </tr>
            </thead>
            <tbody>
                {% for applicant in applicants %}
                <tr class="border-b">
                    <td class="px-4 py-2">{{ loop.index }}</td>
                    <td class="px-4 py-2">{{ applicant.name }}</td>
                    <td class="px-4 py-2">{{ applicant.phone_number }}</td>
                    <td class="px-4 py-2">{{ applicant.role }}</td>
                    <td class="px-4 py-2">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600" name="approve"
                            value="{{ applicant.phone_number }}">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.getElementById('saveBtn').addEventListener('click', function () {
        // Get all rows in the table body
        const rows = document.querySelectorAll('tbody tr');
        const approvedApplicants = [];

        // Loop through each row to collect data only for checked applicants
        rows.forEach(row => {
            const checkbox = row.querySelector('input[name="approve"]');

            // Only collect data if the checkbox is checked
            if (checkbox.checked) {
                const name = row.cells[1].innerText;
                const email = row.cells[2].innerText;
                const role = row.cells[3].innerText;

                // Push the approved applicant's data into the array
                approvedApplicants.push({
                    name: name,
                    email: email,
                    role: role,
                    approved: true
                });
            }
        });

        // Log the approved applicants
        console.log("Approved applicants:", approvedApplicants);

        if (approvedApplicants.length > 0) {
            // Update the approved applicants permission using AJAX (using jQuery)
            $.ajax({
                url: '/su/update_approval', // Replace with your server endpoint
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ approvedApplicants: approvedApplicants }),
                success: function (response) {
                    console.log('Permissions updated successfully:', response);

                    // Fetch the updated table content via AJAX
                    $.ajax({
                        url: '/su/get_updated_table', // New route to get updated table rows
                        method: 'GET',
                        success: function (updatedTableContent) {
                            // Replace the existing table body with the new one
                            document.querySelector('#table-container tbody').innerHTML = updatedTableContent;
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching updated table:', status, error);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Error updating permissions:', status, error);
                }
            });
        }
        else {
            console.log('No Applicants are checked')
        }

        location.reload()
    });


    document.getElementById('cancelBtn').addEventListener('click', function () {
        // Uncheck all checkboxes
        const checkboxes = document.querySelectorAll('input[name="approve"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
    });
</script>
{% endblock %}