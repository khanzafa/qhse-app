{% extends "base.html" %} {% block title %} Dashboard {% endblock %} {% block
content %}
<div class="container mx-auto mt-6 p-6 bg-white shadow-lg rounded-lg">
  <!-- Dashboard Cards Title -->
  <div class="bg-white p-4 rounded-lg shadow mb-8">
    <h3 class="text-xl font-semibold mb-2">Dashboard Overview</h3>
  </div>
  <!-- Dashboard Cards -->
  <div class="flex justify-center mb-8">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
      <!-- Real-Time Date and Time Card -->
      <div
        class="bg-gradient-to-r from-blue-400 to-blue-500 text-white p-4 rounded-lg shadow-lg flex flex-col items-center justify-center transition-transform transform hover:scale-105"
      >
        <i class="fas fa-clock fa-2x mb-2"></i>
        <h3 class="text-lg font-semibold">Timestamp</h3>
        <p id="currentDatetime" class="text-lg font-bold"></p>
      </div>

      <!-- Model Count -->
      <div
        class="bg-gradient-to-r from-fuchsia-400 to-fuchsia-500 text-white p-4 rounded-lg shadow-lg flex flex-col items-center justify-center transition-transform transform hover:scale-105"
      >
        <i class="fas fa-robot fa-2x mb-2"></i>
        <h3 class="text-lg font-semibold">Model Count</h3>
        <p class="text-2xl font-bold">{{ num_weight }}</p>
      </div>

      <!-- CCTV Count -->
      <div
        class="bg-gradient-to-r from-teal-400 to-teal-500 text-white p-4 rounded-lg shadow-lg flex flex-col items-center justify-center transition-transform transform hover:scale-105"
      >
        <i class="fas fa-video fa-2x mb-2"></i>
        <h3 class="text-lg font-semibold">CCTV Count</h3>
        <p class="text-2xl font-bold">{{ num_cctv }}</p>
      </div>

      <!-- Detector Count -->
      <div
        class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-white p-4 rounded-lg shadow-lg flex flex-col items-center justify-center transition-transform transform hover:scale-105"
      >
        <i class="fas fa-bullseye fa-2x mb-2"></i>
        <h3 class="text-lg font-semibold">Detector Count</h3>
        <p class="text-2xl font-bold">{{ num_detectors }}</p>
      </div>

      <!-- Count of Detected Objects -->
      <div
        class="bg-gradient-to-r from-red-400 to-red-500 text-white p-4 rounded-lg shadow-lg flex flex-col items-center justify-center transition-transform transform hover:scale-105"
      >
        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
        <h3 class="text-lg font-semibold">All Detected Objects</h3>
        <p class="text-2xl font-bold">{{ num_all_detection }}</p>
      </div>
    </div>
  </div>
  
  <!-- Filter by Location Section -->
  <div class="mb-8 flex justify-center">
    <form method="GET" action="{{ url_for('report.dashboard') }}">
      <div class="flex items-center space-x-4">
        <!-- Dropdown for Location -->
        <select name="location" id="location" class="bg-gray-200 text-gray-700 p-2 rounded-md">
          <option value="">Select Location</option>
          {% for loc in cctv_locations %}
          <option value="{{ loc }}" {% if selected_location == loc %} selected {% endif %}>{{ loc }}</option>
          {% endfor %}
        </select>

        <!-- Filter Button -->
        <button type="submit" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">
          Filter by Location
        </button>
      </div>
    </form>
  </div>

  <!-- Object Detected Section -->
  <div class="mb-8">

    <h3 class="text-xl font-semibold mb-4 text-gray-800 text-center">
      Weekly Detected Objects (Last 7 Days)
    </h3>
    <div class="flex flex-col md:flex-row justify-between mb-4">
      <!-- Bar Chart -->
      <div class="flex-1 mb-4 md:mb-0">
        <canvas id="ppeBarChart" style="width: 100%; height: 550px"></canvas>
      </div>

      <!-- Pie Chart -->
      <div class="flex-1">
        <canvas id="ppePieChart" style="width: 100%; height: 350px"></canvas>
      </div>
    </div>

    <div class="flex justify-center">
      <div class="flex-1" style="max-width: 70%">
        <canvas
          id="objectTypeBarChart"
          style="width: 100%; height: 400px"
        ></canvas>
      </div>
    </div>
  </div>
  {% endblock %} {% block scripts %} {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script
    src="https://kit.fontawesome.com/a076d05399.js"
    crossorigin="anonymous"
  ></script>

  <script>
    function updateDateTime() {
        const now = new Date();
        const optionsTime = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
        const datetimeString = `${String(now.getDate()).padStart(2, '0')} ${now.toLocaleString('default', { month: 'short' })} ${now.getFullYear()}, ${now.toLocaleTimeString('en-US', optionsTime)}`;
        document.getElementById('currentDatetime').innerText = datetimeString;
    }

    setInterval(updateDateTime, 1000);
    updateDateTime();

    function getRandomColor(alpha = 1) {
        const r = Math.floor(Math.random() * 256);
        const g = Math.floor(Math.random() * 256);
        const b = Math.floor(Math.random() * 256);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getDate()} ${date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;
    }

    const labels = {{ last_7_days|tojson }};
    const formattedLabels = labels.map(formatDate).reverse();
    const numDetectedObjectPerDay = {{ daily_detected_object_counts|tojson }}.reverse();

    const ppeBarChartCtx = document.getElementById('ppeBarChart').getContext('2d');
    const dataset = [{
        type: 'bar',
        label: 'Detected Objects',
        data: numDetectedObjectPerDay,
        backgroundColor: getRandomColor(),
        borderColor: 'rgba(255, 255, 255, 1)',
        borderWidth: 2,
        stack: 'Stack 0'
    }];

    new Chart(ppeBarChartCtx, {
        type: 'bar',
        data: { labels: formattedLabels, datasets: dataset },
        options: {
            plugins: {
                legend: {
                    labels: { color: 'black', font: { size: 15, weight: 'bold' } }
                },
                title: {
                    display: true,
                    text: 'Detected Objects per Day',
                    color: '#333',
                    font: { size: 20, weight: 'bold' }
                },
                datalabels: {
                    color: 'black',
                    font: { weight: 'bold', size: 12 },
                    anchor: 'end',
                    align: 'end',
                    formatter: value => value,
                    offset: 4,
                    borderRadius: 4,
                    padding: 6,
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    borderColor: 'rgba(0, 0, 0, 0.3)',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Date',
                        color: '#555',
                        font: { size: 16, weight: 'bold' }
                    },
                    stacked: true,
                    ticks: { color: 'rgba(32, 33, 33, 0.8)', font: { size: 12, weight: 'bold' } }
                },
                y: {
                    beginAtZero: true,
                    grace: '10%',
                    title: {
                        display: true,
                        text: 'Detected Objects',
                        color: '#555',
                        font: { size: 16, weight: 'bold' }
                    },
                    stacked: true,
                    ticks: { color: 'rgba(32, 33, 33, 0.8)', font: { size: 12, weight: 'bold' } }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    const detectedObjectsLocationPieChartCtx = document.getElementById('ppePieChart').getContext('2d');
    const locations = {{ locations|tojson }};
    const counts = {{ counts|tojson }};
    const pieColors = counts.map(() => getRandomColor());

    new Chart(detectedObjectsLocationPieChartCtx, {
        type: 'pie',
        data: {
            labels: locations,
            datasets: [{
                data: counts,
                backgroundColor: pieColors,
                borderColor: 'rgba(255, 255, 255, 1)',
                borderWidth: 2
            }]
        },
        options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: 'black', font: { size: 15, weight: 'bold' } }
                },
                title: {
                    display: true,
                    text: 'Detected Objects by Camera Location',
                    color: '#333',
                    font: { size: 20, weight: 'bold' }
                },
                datalabels: {
                    formatter: (value, context) => {
                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        return (value / total * 100).toFixed(2) + '%';
                    },
                    color: 'black',
                    font: { size: 15, weight: 'bold' },
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    borderRadius: 3,
                    padding: 4
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    const objectTypeLabels = {{ object_types|tojson }};
    const objectTypeCounts = {{ object_counts|tojson }};
    const backgroundColors = objectTypeCounts.map(() => getRandomColor(0.6));
    const objectTypeBarChartCtx = document.getElementById('objectTypeBarChart').getContext('2d');
    const objectTypeBarChart = new Chart(objectTypeBarChartCtx, {
        type: 'bar',
        data: {
            labels: objectTypeLabels,
            datasets: [{
                data: objectTypeCounts,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color.replace(/0\.6\)/, '1)')),
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // Set to true if you want to show the legend
                },
                title: {
                    display: true,
                    text: 'Most Frequently Detected Object Types',
                    color: '#333',
                    font: { size: 22, weight: 'bold' }
                },
               datalabels: {
                                color: 'black',
                                font: { weight: 'bold', size: 12 },
                                anchor: 'end',
                                align: 'end',
                                formatter: value => value,
                                offset: 4,
                                borderRadius: 4,
                                padding: 6,
                                backgroundColor: 'rgba(255, 255, 255, 0.8)',
                                borderColor: 'rgba(0, 0, 0, 0.3)',
                                borderWidth: 1
                            }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Count',
                        color: '#555',
                        font: { size: 16, weight: 'bold' }
                    },
                    beginAtZero: true,
                    grace: '10%',
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(32, 33, 33, 0.8)',
                        font: { size: 14, weight: 'bold' }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Object Types',
                        color: '#555',
                        font: { size: 16, weight: 'bold' }
                    },
                    ticks: {
                        color: 'rgba(32, 33, 33, 0.8)',
                        font: { size: 14, weight: 'bold' }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
  </script>

  {% endblock %}
</div>
